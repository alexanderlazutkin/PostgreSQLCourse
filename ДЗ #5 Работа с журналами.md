## Домашнее задание "Работа с журналами"

### Цель:
-   уметь работать с журналами и контрольными точками
-   уметь настраивать параметры журналов

### Описание/Пошаговая инструкция выполнения домашнего задания:

####   установить на него PostgreSQL 14 с дефолтными настройками
ssh user@158.160.28.244
sudo apt -y install gnupg2 wget vim
sudo apt -y update
sudo apt -y install postgresql-14
sudo -u postgres psql
ALTER USER postgres WITH PASSWORD 'postgres';


#### Настройте выполнение контрольной точки раз в 30 секунд.

--Sets the maximum time between automatic WAL checkpoints.
ALTER SYSTEM SET checkpoint_timeout TO '30s';
\q
sudo pg_ctlcluster restart 14 main

#### 10 минут c помощью утилиты pgbench подавайте нагрузку.

sudo -u postgres psql
\c buffer_tmp


-- Инициализация БД buffer_tmp для pgbench
sudo -u postgres pgbench -i buffer_tmp

--Получаем начальный LSN перед запуском теста
SELECT pg_current_wal_insert_lsn();
>pg_current_wal_insert_lsn
>0/1E3BBFC8

\q

-- Запуск теста 
sudo -u postgres pgbench -P 60 -T 600 buffer_tmp
sudo -u postgres pgbench -P 60 -T 600 buffer_tmp
pgbench (14.7 (Ubuntu 14.7-0ubuntu0.22.04.1))
starting vacuum...end.
progress: 60.0 s, 606.6 tps, lat 1.648 ms stddev 1.579
progress: 120.0 s, 452.6 tps, lat 2.209 ms stddev 2.171
progress: 180.0 s, 482.2 tps, lat 2.074 ms stddev 3.342
progress: 240.0 s, 527.2 tps, lat 1.896 ms stddev 1.836
progress: 300.0 s, 528.7 tps, lat 1.891 ms stddev 3.085
progress: 360.0 s, 605.5 tps, lat 1.651 ms stddev 1.496
progress: 420.0 s, 538.4 tps, lat 1.857 ms stddev 1.793
progress: 480.0 s, 502.9 tps, lat 1.988 ms stddev 3.243
progress: 540.0 s, 499.6 tps, lat 2.002 ms stddev 1.847
progress: 600.0 s, 568.6 tps, lat 1.758 ms stddev 2.887
transaction type: <builtin: TPC-B (sort of)>
scaling factor: 1
query mode: simple
number of clients: 1
number of threads: 1
duration: 600 s
number of transactions actually processed: 318737
latency average = 1.882 ms
latency stddev = 2.408 ms
initial connection time = 2.923 ms
tps = 531.229276 (without initial connection time)

--Получаем LSN после теста
SELECT pg_current_wal_insert_lsn();
>pg_current_wal_insert_lsn
 >0/36602FB8
 
 
#### Измерьте, какой объем журнальных файлов был сгенерирован за это время. Оцените, какой объем приходится в среднем на одну контрольную точку.

 SELECT '0/36602FB8'::pg_lsn - '0/1E3BBFC8'::pg_lsn;
> 405041136

было сгенерировано 405041136 байт  
за 10 минут должно быть создано 20 контрольных точек, => 405041136 / 20 = 20 252 057 байт должно в среднем быть на одну контрольную точку

#### Проверьте данные статистики: все ли контрольные точки выполнялись точно по расписанию. Почему так произошло?
-- статистика для анализа фоновой записи
select * from pg_stat_bgwriter \gx
-[ RECORD 1 ]---------+------------------------------
checkpoints_timed     | 117
checkpoints_req       | 4
checkpoint_write_time | 1183649
checkpoint_sync_time  | 1053
buffers_checkpoint    | 82794
buffers_clean         | 0
maxwritten_clean      | 0
buffers_backend       | 6241
buffers_backend_fsync | 0
buffers_alloc         | 10408
stats_reset           | 2023-03-18 09:25:34.879622+00

#### Сравните tps в синхронном/асинхронном режиме утилитой pgbench. Объясните полученный результат.


####  Создайте новый кластер с включенной контрольной суммой страниц. Создайте таблицу. Вставьте несколько значений. Выключите кластер. Измените пару байт в таблице. Включите кластер и сделайте выборку из таблицы. Что и почему произошло? как проигнорировать ошибку и продолжить работу?

<!--stackedit_data:
eyJoaXN0b3J5IjpbNzc3Njg5NzA4LC0zMzI1Njk0MzksLTE0ND
g5MDI2MjksLTE5MjQ3Njk3MTIsLTIxMDg0OTM1MSwxNTQ1MzI5
OTg3LDIwMTI0NjgxOTcsLTM0OTI2Mjg4NSwxMDIxMDA0MDI0LC
0xOTkxNTAxOTE0XX0=
-->