## Домашнее задание "Работа с журналами"

### Цель:
-   уметь работать с журналами и контрольными точками
-   уметь настраивать параметры журналов

### Описание/Пошаговая инструкция выполнения домашнего задания:

####   установить на него PostgreSQL 14 с дефолтными настройками
ssh user@158.160.28.244
sudo apt -y install gnupg2 wget vim
sudo apt -y update
sudo apt -y install postgresql-14
sudo -u postgres psql
ALTER USER postgres WITH PASSWORD 'postgres';


#### Настройте выполнение контрольной точки раз в 30 секунд.

--Sets the maximum time between automatic WAL checkpoints.
ALTER SYSTEM SET checkpoint_timeout TO '30s';
\q
sudo pg_ctlcluster restart 14 main

#### 10 минут c помощью утилиты pgbench подавайте нагрузку.

sudo -u postgres psql
\c buffer_tmp


-- Инициализация БД buffer_tmp для pgbench
sudo -u postgres pgbench -i buffer_tmp

-- Сброс счетчиков
SELECT pg_stat_reset();
SELECT pg_stat_reset_shared('bgwriter');

--Получаем начальный LSN перед запуском теста
SELECT pg_current_wal_insert_lsn();
> 0/5613B540

\q

-- Запуск теста 
sudo -u postgres pgbench -P 60 -T 600 buffer_tmp

pgbench (14.7 (Ubuntu 14.7-0ubuntu0.22.04.1))
starting vacuum...end.
progress: 60.0 s, 658.4 tps, lat 1.518 ms stddev 1.465
progress: 120.0 s, 621.2 tps, lat 1.609 ms stddev 2.855
progress: 180.0 s, 668.8 tps, lat 1.495 ms stddev 1.272
progress: 240.0 s, 617.6 tps, lat 1.619 ms stddev 1.492
progress: 300.0 s, 457.6 tps, lat 2.185 ms stddev 3.578
progress: 360.0 s, 550.7 tps, lat 1.816 ms stddev 1.874
progress: 420.0 s, 553.3 tps, lat 1.807 ms stddev 3.093
progress: 480.0 s, 649.2 tps, lat 1.540 ms stddev 1.369
progress: 540.0 s, 651.8 tps, lat 1.534 ms stddev 1.254
progress: 600.0 s, 564.0 tps, lat 1.773 ms stddev 3.325
transaction type: <builtin: TPC-B (sort of)>
scaling factor: 1
query mode: simple
number of clients: 1
number of threads: 1
duration: 600 s
number of transactions actually processed: 359558
latency average = 1.668 ms
latency stddev = 2.264 ms
initial connection time = 2.622 ms
tps = 599.265848 (without initial connection time)

--Получаем LSN после теста
SELECT pg_current_wal_insert_lsn();
 >0/6FDDF840
 
 
#### Измерьте, какой объем журнальных файлов был сгенерирован за это время. Оцените, какой объем приходится в среднем на одну контрольную точку.

SELECT '0/6FDDF840'::pg_lsn - '0/5613B540'::pg_lsn;
> 432685824

было сгенерировано 432685824 байт  
за 10 минут должно быть создано 20 контрольных точек, => 432685824 / 20 = 21634291 байт должно в среднем быть на одну контрольную точку

#### Проверьте данные статистики: все ли контрольные точки выполнялись точно по расписанию. Почему так произошло?
-- статистика для анализа фоновой записи
select * from pg_stat_bgwriter \gx

checkpoints_timed     = 25                         
checkpoints_req       = 0                          
checkpoint_write_time = 564791                     
checkpoint_sync_time  = 442                        
buffers_checkpoint    = 38525                      
buffers_clean         = 0                          
maxwritten_clean      = 0                          
buffers_backend       = 2300                       
buffers_backend_fsync = 0                          
buffers_alloc         = 2296                       
stats_reset           = 2023-03-18 14:42:53.131215 



#### Сравните tps в синхронном/асинхронном режиме утилитой pgbench. Объясните полученный результат.


####  Создайте новый кластер с включенной контрольной суммой страниц. Создайте таблицу. Вставьте несколько значений. Выключите кластер. Измените пару байт в таблице. Включите кластер и сделайте выборку из таблицы. Что и почему произошло? как проигнорировать ошибку и продолжить работу?

<!--stackedit_data:
eyJoaXN0b3J5IjpbLTI2MzcyMzIyNiwxMDUzMDM2MDk4LDkwNj
IwMjE0MSwxNDM3ODAzOTc3LDc3NzY4OTcwOCwtMzMyNTY5NDM5
LC0xNDQ4OTAyNjI5LC0xOTI0NzY5NzEyLC0yMTA4NDkzNTEsMT
U0NTMyOTk4NywyMDEyNDY4MTk3LC0zNDkyNjI4ODUsMTAyMTAw
NDAyNCwtMTk5MTUwMTkxNF19
-->