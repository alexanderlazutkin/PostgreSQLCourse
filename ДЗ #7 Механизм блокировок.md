## Домашнее задание "Механизм блокировок"
***Цель: понимать как работает механизм блокировок объектов и строк***

### Описание/Пошаговая инструкция выполнения домашнего задания:

####  Настройте сервер так, чтобы в журнал сообщений сбрасывалась информация о блокировках, удерживаемых более 200 миллисекунд. Воспроизведите ситуацию, при которой в журнале появятся такие сообщения.
ssh user@130.193.41.150
sudo -u postgres psql

***Сбросим параметры с предыдущего занятия***
ALTER SYSTEM RESET ALL;

select pg_reload_conf();

***Создадим базу для тестирования***

create database db_locks;

\c db_locks;
You are now connected to database "db_locks" as user "postgres".

CREATE TABLE test_locks (id serial, descr text);

INSERT INTO test_locks(descr) SELECT md5(RANDOM()::TEXT) FROM generate_series(1,100);

select count(*) from test_locks;
>100

***Установим параметр, к-й записывает в журнал продолжительность выполнения всех команд, время работы которых не меньше указанного***

alter system set log_min_duration_statement = 200;

SELECT pg_reload_conf();

show log_min_duration_statement;
> 200ms

***Воспроизведем блокировку с помощью Update на определенное значение:***

BEGIN TRANSACTION;

UPDATE test_locks SET descr = ' test 1'  WHERE id = 1;

select * from test_locks order by id limit 5;

 id |              descr
----+----------------------------------
  1 |  test 1
  2 | b62f5ce81941966820747dd1ff93c4b0
  3 | 6375dffc645f5485af3b25a84602717e
  4 | 1ec7eaf1d96e59210e0b82e7d95ec85a
  5 | 5ba75899de3a14e6c6c6c92a50503562
  
Во втором окне выполним ту же операцию Update с тем же полем:
db_locks=# BEGIN TRANSACTION;
BEGIN
db_locks=*# UPDATE test_locks SET descr = ' test 2'  WHERE id = 1;
UPDATE 1
Во втором окне блокировка пропала и транзакция может быть также завершена:
db_locks=*# COMMIT;
COMMIT

Проверим лог из журнала на предмет появления в нем записи блокировки:
user@postgres:~$ sudo tail -n 3 /var/log/postgresql/postgresql-14-main.log
BEGIN TRANSACTION;
2023-03-19 08:01:51.481 UTC [1563] postgres@db_locks LOG:  duration: 64586.570 ms  statement: UPDATE test_locks SET descr = ' test 2'  WHERE id = 1;
=> в журнал попала транзакция №2, которая ожидала блокировку.

#### Смоделируйте ситуацию обновления одной и той же строки тремя командами UPDATE в разных сеансах. Изучите возникшие блокировки в представлении pg_locks и убедитесь, что все они понятны. Пришлите список блокировок и объясните, что значит каждая.


#### Воспроизведите взаимоблокировку трех транзакций. Можно ли разобраться в ситуации постфактум, изучая журнал сообщений?


#### Могут ли две транзакции, выполняющие единственную команду UPDATE одной и той же таблицы (без where), заблокировать друг друга?


<!--stackedit_data:
eyJoaXN0b3J5IjpbMjEzMjMzOTE5NiwtNjI0MjAwNTc3LDIyMz
E2NzE2OCwxNDY0MzAzODUxXX0=
-->